{"ast":null,"code":"\"use strict\";\n\nconst AbstractQuery = require(\"../abstract/query\");\n\nconst sequelizeErrors = require(\"../../errors\");\n\nconst _ = require(\"lodash\");\n\nconst {\n  logger\n} = require(\"../../utils/logger\");\n\nconst ER_DUP_ENTRY = 1062;\nconst ER_DEADLOCK = 1213;\nconst ER_ROW_IS_REFERENCED = 1451;\nconst ER_NO_REFERENCED_ROW = 1452;\nconst debug = logger.debugContext(\"sql:snowflake\");\n\nclass Query extends AbstractQuery {\n  static formatBindParameters(sql, values, dialect) {\n    const bindParam = [];\n\n    const replacementFunc = (_match, key, values_) => {\n      if (values_[key] !== void 0) {\n        bindParam.push(values_[key]);\n        return \"?\";\n      }\n\n      return void 0;\n    };\n\n    sql = AbstractQuery.formatBindParameters(sql, values, dialect, replacementFunc)[0];\n    return [sql, bindParam.length > 0 ? bindParam : void 0];\n  }\n\n  async run(sql, parameters) {\n    this.sql = sql;\n    const {\n      connection,\n      options\n    } = this;\n    const showWarnings = this.sequelize.options.showWarnings || options.showWarnings;\n\n    const complete = this._logQuery(sql, debug, parameters);\n\n    if (parameters) {\n      debug(\"parameters(%j)\", parameters);\n    }\n\n    let results;\n\n    try {\n      results = await new Promise((resolve, reject) => {\n        connection.execute({\n          sqlText: sql,\n          binds: parameters,\n\n          complete(err, _stmt, rows) {\n            if (err) {\n              reject(err);\n            } else {\n              resolve(rows);\n            }\n          }\n\n        });\n      });\n    } catch (error) {\n      if (options.transaction && error.errno === ER_DEADLOCK) {\n        try {\n          await options.transaction.rollback();\n        } catch (error_) {}\n\n        options.transaction.finished = \"rollback\";\n      }\n\n      error.sql = sql;\n      error.parameters = parameters;\n      throw this.formatError(error);\n    } finally {\n      complete();\n    }\n\n    if (showWarnings && results && results.warningStatus > 0) {\n      await this.logWarnings(results);\n    }\n\n    return this.formatResults(results);\n  }\n\n  formatResults(data) {\n    let result = this.instance;\n\n    if (this.isInsertQuery(data)) {\n      this.handleInsertQuery(data);\n\n      if (!this.instance) {\n        if (data.constructor.name === \"ResultSetHeader\" && this.model && this.model.autoIncrementAttribute && this.model.autoIncrementAttribute === this.model.primaryKeyAttribute && this.model.rawAttributes[this.model.primaryKeyAttribute]) {\n          const startId = data[this.getInsertIdField()];\n          result = [];\n\n          for (let i = startId; i < startId + data.affectedRows; i++) {\n            result.push({\n              [this.model.rawAttributes[this.model.primaryKeyAttribute].field]: i\n            });\n          }\n        } else {\n          result = data[this.getInsertIdField()];\n        }\n      }\n    }\n\n    if (this.isSelectQuery()) {\n      if (this.options.raw === false && this.sequelize.options.quoteIdentifiers === false) {\n        const sfAttrMap = _.reduce(this.model.rawAttributes, (m, v, k) => {\n          m[k.toUpperCase()] = k;\n          return m;\n        }, {});\n\n        data = data.map(data2 => _.reduce(data2, (prev, value, key) => {\n          if (value !== void 0 && sfAttrMap[key]) {\n            prev[sfAttrMap[key]] = value;\n            delete prev[key];\n          }\n\n          return prev;\n        }, data2));\n      }\n\n      this.options.fieldMap = _.mapKeys(this.options.fieldMap, (v, k) => {\n        return k.toUpperCase();\n      });\n      return this.handleSelectQuery(data);\n    }\n\n    if (this.isShowTablesQuery()) {\n      return this.handleShowTablesQuery(data);\n    }\n\n    if (this.isDescribeQuery()) {\n      result = {};\n\n      for (const _result of data) {\n        result[_result.Field] = {\n          type: _result.Type.toUpperCase(),\n          allowNull: _result.Null === \"YES\",\n          defaultValue: _result.Default,\n          primaryKey: _result.Key === \"PRI\",\n          autoIncrement: Object.prototype.hasOwnProperty.call(_result, \"Extra\") && _result.Extra.toLowerCase() === \"auto_increment\",\n          comment: _result.Comment ? _result.Comment : null\n        };\n      }\n\n      return result;\n    }\n\n    if (this.isShowIndexesQuery()) {\n      return this.handleShowIndexesQuery(data);\n    }\n\n    if (this.isCallQuery()) {\n      return data[0];\n    }\n\n    if (this.isBulkUpdateQuery() || this.isBulkDeleteQuery()) {\n      return data[0][\"number of rows updated\"];\n    }\n\n    if (this.isVersionQuery()) {\n      return data[0].version;\n    }\n\n    if (this.isForeignKeysQuery()) {\n      return data;\n    }\n\n    if (this.isUpsertQuery()) {\n      return [result, data.affectedRows === 1];\n    }\n\n    if (this.isInsertQuery() || this.isUpdateQuery()) {\n      return [result, data.affectedRows];\n    }\n\n    if (this.isShowConstraintsQuery()) {\n      return data;\n    }\n\n    if (this.isRawQuery()) {\n      return [data, data];\n    }\n\n    return result;\n  }\n\n  async logWarnings(results) {\n    const warningResults = await this.run(\"SHOW WARNINGS\");\n    const warningMessage = `Snowflake Warnings (${this.connection.uuid || \"default\"}): `;\n    const messages = [];\n\n    for (const _warningRow of warningResults) {\n      if (_warningRow === void 0 || typeof _warningRow[Symbol.iterator] !== \"function\") {\n        continue;\n      }\n\n      for (const _warningResult of _warningRow) {\n        if (Object.prototype.hasOwnProperty.call(_warningResult, \"Message\")) {\n          messages.push(_warningResult.Message);\n        } else {\n          for (const _objectKey of _warningResult.keys()) {\n            messages.push([_objectKey, _warningResult[_objectKey]].join(\": \"));\n          }\n        }\n      }\n    }\n\n    this.sequelize.log(warningMessage + messages.join(\"; \"), this.options);\n    return results;\n  }\n\n  formatError(err) {\n    const errCode = err.errno || err.code;\n\n    switch (errCode) {\n      case ER_DUP_ENTRY:\n        {\n          const match = err.message.match(/Duplicate entry '([\\s\\S]*)' for key '?((.|\\s)*?)'?$/);\n          let fields = {};\n          let message = \"Validation error\";\n          const values = match ? match[1].split(\"-\") : void 0;\n          const fieldKey = match ? match[2] : void 0;\n          const fieldVal = match ? match[1] : void 0;\n          const uniqueKey = this.model && this.model.uniqueKeys[fieldKey];\n\n          if (uniqueKey) {\n            if (uniqueKey.msg) message = uniqueKey.msg;\n            fields = _.zipObject(uniqueKey.fields, values);\n          } else {\n            fields[fieldKey] = fieldVal;\n          }\n\n          const errors = [];\n\n          _.forOwn(fields, (value, field) => {\n            errors.push(new sequelizeErrors.ValidationErrorItem(this.getUniqueConstraintErrorMessage(field), \"unique violation\", field, value, this.instance, \"not_unique\"));\n          });\n\n          return new sequelizeErrors.UniqueConstraintError({\n            message,\n            errors,\n            parent: err,\n            fields\n          });\n        }\n\n      case ER_ROW_IS_REFERENCED:\n      case ER_NO_REFERENCED_ROW:\n        {\n          const match = err.message.match(/CONSTRAINT ([`\"])(.*)\\1 FOREIGN KEY \\(\\1(.*)\\1\\) REFERENCES \\1(.*)\\1 \\(\\1(.*)\\1\\)/);\n          const quoteChar = match ? match[1] : \"`\";\n          const fields = match ? match[3].split(new RegExp(`${quoteChar}, *${quoteChar}`)) : void 0;\n          return new sequelizeErrors.ForeignKeyConstraintError({\n            reltype: String(errCode) === String(ER_ROW_IS_REFERENCED) ? \"parent\" : \"child\",\n            table: match ? match[4] : void 0,\n            fields,\n            value: fields && fields.length && this.instance && this.instance[fields[0]] || void 0,\n            index: match ? match[2] : void 0,\n            parent: err\n          });\n        }\n\n      default:\n        return new sequelizeErrors.DatabaseError(err);\n    }\n  }\n\n  handleShowIndexesQuery(data) {\n    data = data.reduce((acc, item) => {\n      if (!(item.Key_name in acc)) {\n        acc[item.Key_name] = item;\n        item.fields = [];\n      }\n\n      acc[item.Key_name].fields[item.Seq_in_index - 1] = {\n        attribute: item.Column_name,\n        length: item.Sub_part || void 0,\n        order: item.Collation === \"A\" ? \"ASC\" : void 0\n      };\n      delete item.column_name;\n      return acc;\n    }, {});\n    return _.map(data, item => ({\n      primary: item.Key_name === \"PRIMARY\",\n      fields: item.fields,\n      name: item.Key_name,\n      tableName: item.Table,\n      unique: item.Non_unique !== 1,\n      type: item.Index_type\n    }));\n  }\n\n}\n\nmodule.exports = Query;\nmodule.exports.Query = Query;\nmodule.exports.default = Query;","map":{"version":3,"mappings":";;AAEA,MAAMA,gBAAgBC,QAAQ,mBAAR,CAAtB;;AACA,MAAMC,kBAAkBD,QAAQ,cAAR,CAAxB;;AACA,MAAME,IAAIF,QAAQ,QAAR,CAAV;;AACA,MAAM;EAAEG;AAAF,IAAaH,QAAQ,oBAAR,CAAnB;;AAEA,MAAMI,eAAe,IAArB;AACA,MAAMC,cAAc,IAApB;AACA,MAAMC,uBAAuB,IAA7B;AACA,MAAMC,uBAAuB,IAA7B;AAEA,MAAMC,QAAQL,OAAOM,YAAP,CAAoB,eAApB,CAAd;;AAEA,oBAAoBV,aAApB,CAAkC;EACzB,4BAAqBW,GAArB,EAA0BC,MAA1B,EAAkCC,OAAlC,EAA2C;IAChD,MAAMC,YAAY,EAAlB;;IACA,MAAMC,kBAAkB,CAACC,MAAD,EAASC,GAAT,EAAcC,OAAd,KAA0B;MAChD,IAAIA,QAAQD,GAAR,MAAiB,MAArB,EAAgC;QAC9BH,UAAUK,IAAV,CAAeD,QAAQD,GAAR,CAAf;QACA,OAAO,GAAP;MAAO;;MAET,OAAO,MAAP;IAAO,CALT;;IAOAN,MAAMX,cAAcoB,oBAAd,CAAmCT,GAAnC,EAAwCC,MAAxC,EAAgDC,OAAhD,EAAyDE,eAAzD,EAA0E,CAA1E,CAAN;IACA,OAAO,CAACJ,GAAD,EAAMG,UAAUO,MAAV,GAAmB,CAAnB,GAAuBP,SAAvB,GAAmC,MAAzC,CAAP;EAAgD;;EAG5C,UAAIH,GAAJ,EAASW,UAAT,EAAqB;IACzB,KAAKX,GAAL,GAAWA,GAAX;IACA,MAAM;MAAEY,UAAF;MAAcC;IAAd,IAA0B,IAAhC;IAEA,MAAMC,eAAe,KAAKC,SAAL,CAAeF,OAAf,CAAuBC,YAAvB,IAAuCD,QAAQC,YAApE;;IAEA,MAAME,WAAW,KAAKC,SAAL,CAAejB,GAAf,EAAoBF,KAApB,EAA2Ba,UAA3B,CAAjB;;IAEA,IAAIA,UAAJ,EAAgB;MACdb,MAAM,gBAAN,EAAwBa,UAAxB;IAAwB;;IAG1B,IAAIO,OAAJ;;IAEA,IAAI;MACFA,UAAU,MAAM,IAAIC,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;QAC/CT,WAAWU,OAAX,CAAmB;UACjBC,SAASvB,GADQ;UAEjBwB,OAAOb,UAFU;;UAGjBK,SAASS,GAAT,EAAcC,KAAd,EAAqBC,IAArB,EAA2B;YACzB,IAAIF,GAAJ,EAAS;cACPJ,OAAOI,GAAP;YAAO,CADT,MAEO;cACLL,QAAQO,IAAR;YAAQ;UAAA;;QAPK,CAAnB;MAOc,CARA,CAAhB;IAQgB,CATlB,CASkB,OAKTC,KALS,EAKhB;MACA,IAAIf,QAAQgB,WAAR,IAAuBD,MAAME,KAAN,KAAgBnC,WAA3C,EAAwD;QACtD,IAAI;UACF,MAAMkB,QAAQgB,WAAR,CAAoBE,QAApB,EAAN;QAA0B,CAD5B,CAC4B,OACnBC,MADmB,EAC1B;;QAIFnB,QAAQgB,WAAR,CAAoBI,QAApB,GAA+B,UAA/B;MAA+B;;MAGjCL,MAAM5B,GAAN,GAAYA,GAAZ;MACA4B,MAAMjB,UAAN,GAAmBA,UAAnB;MACA,MAAM,KAAKuB,WAAL,CAAiBN,KAAjB,CAAN;IAAuB,CA3BzB,SA4BE;MACAZ;IAAA;;IAGF,IAAIF,gBAAgBI,OAAhB,IAA2BA,QAAQiB,aAAR,GAAwB,CAAvD,EAA0D;MACxD,MAAM,KAAKC,WAAL,CAAiBlB,OAAjB,CAAN;IAAuB;;IAEzB,OAAO,KAAKmB,aAAL,CAAmBnB,OAAnB,CAAP;EAA0B;;EAoB5BmB,cAAcC,IAAd,EAAoB;IAClB,IAAIC,SAAS,KAAKC,QAAlB;;IAEA,IAAI,KAAKC,aAAL,CAAmBH,IAAnB,CAAJ,EAA8B;MAC5B,KAAKI,iBAAL,CAAuBJ,IAAvB;;MAEA,IAAI,CAAC,KAAKE,QAAV,EAAoB;QAElB,IACEF,KAAKK,WAAL,CAAiBC,IAAjB,KAA0B,iBAA1B,IACG,KAAKC,KADR,IAEG,KAAKA,KAAL,CAAWC,sBAFd,IAGG,KAAKD,KAAL,CAAWC,sBAAX,KAAsC,KAAKD,KAAL,CAAWE,mBAHpD,IAIG,KAAKF,KAAL,CAAWG,aAAX,CAAyB,KAAKH,KAAL,CAAWE,mBAApC,CALL,EAME;UACA,MAAME,UAAUX,KAAK,KAAKY,gBAAL,EAAL,CAAhB;UACAX,SAAS,EAAT;;UACA,SAASY,IAAIF,OAAb,EAAsBE,IAAIF,UAAUX,KAAKc,YAAzC,EAAuDD,GAAvD,EAA4D;YAC1DZ,OAAO/B,IAAP,CAAY;cAAA,CAAG,KAAKqC,KAAL,CAAWG,aAAX,CAAyB,KAAKH,KAAL,CAAWE,mBAApC,EAAyDM,KAA5D,GAAoEF;YAApE,CAAZ;UAAgF;QAAA,CAVpF,MAYO;UACLZ,SAASD,KAAK,KAAKY,gBAAL,EAAL,CAAT;QAAmB;MAAA;IAAA;;IAKzB,IAAI,KAAKI,aAAL,EAAJ,EAA0B;MAGxB,IAAI,KAAKzC,OAAL,CAAa0C,GAAb,KAAqB,KAArB,IAA8B,KAAKxC,SAAL,CAAeF,OAAf,CAAuB2C,gBAAvB,KAA4C,KAA9E,EAAqF;QACnF,MAAMC,YAAYjE,EAAEkE,MAAF,CAAS,KAAKb,KAAL,CAAWG,aAApB,EAAmC,CAACW,CAAD,EAAIC,CAAJ,EAAOC,CAAP,KAAa;UAChEF,EAAEE,EAAEC,WAAF,EAAF,IAAqBD,CAArB;UACA,OAAOF,CAAP;QAAO,CAFS,EAGf,EAHe,CAAlB;;QAKArB,OAAOA,KAAKyB,GAAL,CAASC,SAAQxE,EAAEkE,MAAF,CAASM,KAAT,EAAe,CAACC,IAAD,EAAOC,KAAP,EAAc5D,GAAd,KAAsB;UAC3D,IAAK4D,UAAU,MAAV,IAAuBT,UAAUnD,GAAV,CAA5B,EAA6C;YAC3C2D,KAAKR,UAAUnD,GAAV,CAAL,IAAuB4D,KAAvB;YACA,OAAOD,KAAK3D,GAAL,CAAP;UAAY;;UAEd,OAAO2D,IAAP;QAAO,CALe,EAMrBD,KANqB,CAAjB,CAAP;MAMG;;MAGL,KAAKnD,OAAL,CAAasD,QAAb,GAAwB3E,EAAE4E,OAAF,CAAU,KAAKvD,OAAL,CAAasD,QAAvB,EAAiC,CAACP,CAAD,EAAIC,CAAJ,KAAU;QAAE,OAAOA,EAAEC,WAAF,EAAP;MAAS,CAAtD,CAAxB;MAEA,OAAO,KAAKO,iBAAL,CAAuB/B,IAAvB,CAAP;IAA8B;;IAGhC,IAAI,KAAKgC,iBAAL,EAAJ,EAA8B;MAC5B,OAAO,KAAKC,qBAAL,CAA2BjC,IAA3B,CAAP;IAAkC;;IAGpC,IAAI,KAAKkC,eAAL,EAAJ,EAA4B;MAC1BjC,SAAS,EAAT;;MAEA,WAAWkC,OAAX,IAAsBnC,IAAtB,EAA4B;QAC1BC,OAAOkC,QAAQC,KAAf,IAAwB;UACtBC,MAAMF,QAAQG,IAAR,CAAad,WAAb,EADgB;UAEtBe,WAAWJ,QAAQK,IAAR,KAAiB,KAFN;UAGtBC,cAAcN,QAAQO,OAHA;UAItBC,YAAYR,QAAQS,GAAR,KAAgB,KAJN;UAKtBC,eAAeC,OAAOC,SAAP,CAAiBC,cAAjB,CAAgCC,IAAhC,CAAqCd,OAArC,EAA8C,OAA9C,KACVA,QAAQe,KAAR,CAAcC,WAAd,OAAgC,gBANf;UAOtBC,SAASjB,QAAQkB,OAAR,GAAkBlB,QAAQkB,OAA1B,GAAoC;QAPvB,CAAxB;MAO+C;;MAGjD,OAAOpD,MAAP;IAAO;;IAET,IAAI,KAAKqD,kBAAL,EAAJ,EAA+B;MAC7B,OAAO,KAAKC,sBAAL,CAA4BvD,IAA5B,CAAP;IAAmC;;IAErC,IAAI,KAAKwD,WAAL,EAAJ,EAAwB;MACtB,OAAOxD,KAAK,CAAL,CAAP;IAAY;;IAEd,IAAI,KAAKyD,iBAAL,MAA4B,KAAKC,iBAAL,EAAhC,EAA0D;MACxD,OAAO1D,KAAK,CAAL,EAAQ,wBAAR,CAAP;IAAe;;IAEjB,IAAI,KAAK2D,cAAL,EAAJ,EAA2B;MACzB,OAAO3D,KAAK,CAAL,EAAQ4D,OAAf;IAAe;;IAEjB,IAAI,KAAKC,kBAAL,EAAJ,EAA+B;MAC7B,OAAO7D,IAAP;IAAO;;IAET,IAAI,KAAK8D,aAAL,EAAJ,EAA0B;MACxB,OAAO,CAAC7D,MAAD,EAASD,KAAKc,YAAL,KAAsB,CAA/B,CAAP;IAAsC;;IAExC,IAAI,KAAKX,aAAL,MAAwB,KAAK4D,aAAL,EAA5B,EAAkD;MAChD,OAAO,CAAC9D,MAAD,EAASD,KAAKc,YAAd,CAAP;IAAqB;;IAEvB,IAAI,KAAKkD,sBAAL,EAAJ,EAAmC;MACjC,OAAOhE,IAAP;IAAO;;IAET,IAAI,KAAKiE,UAAL,EAAJ,EAAuB;MACrB,OAAO,CAACjE,IAAD,EAAOA,IAAP,CAAP;IAAc;;IAGhB,OAAOC,MAAP;EAAO;;EAGH,kBAAYrB,OAAZ,EAAqB;IACzB,MAAMsF,iBAAiB,MAAM,KAAKC,GAAL,CAAS,eAAT,CAA7B;IACA,MAAMC,iBAAiB,uBAAuB,KAAK9F,UAAL,CAAgB+F,IAAhB,IAAwB,cAAtE;IACA,MAAMC,WAAW,EAAjB;;IACA,WAAWC,WAAX,IAA0BL,cAA1B,EAA0C;MACxC,IAAIK,gBAAgB,MAAhB,IAA6B,OAAOA,YAAYC,OAAOC,QAAnB,CAAP,KAAwC,UAAzE,EAAqF;QACnF;MAAA;;MAEF,WAAWC,cAAX,IAA6BH,WAA7B,EAA0C;QACxC,IAAIzB,OAAOC,SAAP,CAAiBC,cAAjB,CAAgCC,IAAhC,CAAqCyB,cAArC,EAAqD,SAArD,CAAJ,EAAqE;UACnEJ,SAASpG,IAAT,CAAcwG,eAAeC,OAA7B;QAA6B,CAD/B,MAEO;UACL,WAAWC,UAAX,IAAyBF,eAAeG,IAAf,EAAzB,EAAgD;YAC9CP,SAASpG,IAAT,CAAc,CAAC0G,UAAD,EAAaF,eAAeE,UAAf,CAAb,EAAyCE,IAAzC,CAA8C,IAA9C,CAAd;UAA4D;QAAA;MAAA;IAAA;;IAMpE,KAAKrG,SAAL,CAAesG,GAAf,CAAmBX,iBAAiBE,SAASQ,IAAT,CAAc,IAAd,CAApC,EAAyD,KAAKvG,OAA9D;IAEA,OAAOK,OAAP;EAAO;;EAGTgB,YAAYT,GAAZ,EAAiB;IACf,MAAM6F,UAAU7F,IAAIK,KAAJ,IAAaL,IAAI8F,IAAjC;;IAEA,QAAQD,OAAR;MAAQ,KACD5H,YADC;QACa;UACjB,MAAM8H,QAAQ/F,IAAIgG,OAAJ,CAAYD,KAAZ,CAAkB,qDAAlB,CAAd;UACA,IAAIE,SAAS,EAAb;UACA,IAAID,UAAU,kBAAd;UACA,MAAMxH,SAASuH,QAAQA,MAAM,CAAN,EAASG,KAAT,CAAe,GAAf,CAAR,GAA8B,MAA7C;UACA,MAAMC,WAAWJ,QAAQA,MAAM,CAAN,CAAR,GAAmB,MAApC;UACA,MAAMK,WAAWL,QAAQA,MAAM,CAAN,CAAR,GAAmB,MAApC;UACA,MAAMM,YAAY,KAAKjF,KAAL,IAAc,KAAKA,KAAL,CAAWkF,UAAX,CAAsBH,QAAtB,CAAhC;;UAEA,IAAIE,SAAJ,EAAe;YACb,IAAIA,UAAUE,GAAd,EAAmBP,UAAUK,UAAUE,GAApB;YACnBN,SAASlI,EAAEyI,SAAF,CAAYH,UAAUJ,MAAtB,EAA8BzH,MAA9B,CAAT;UAAuC,CAFzC,MAGO;YACLyH,OAAOE,QAAP,IAAmBC,QAAnB;UAAmB;;UAGrB,MAAMK,SAAS,EAAf;;UACA1I,EAAE2I,MAAF,CAAST,MAAT,EAAiB,CAACxD,KAAD,EAAQb,KAAR,KAAkB;YACjC6E,OAAO1H,IAAP,CAAY,IAAIjB,gBAAgB6I,mBAApB,CACV,KAAKC,+BAAL,CAAqChF,KAArC,CADU,EAEV,kBAFU,EAGVA,KAHU,EAIVa,KAJU,EAKV,KAAK1B,QALK,EAMV,YANU,CAAZ;UAME,CAPJ;;UAWA,OAAO,IAAIjD,gBAAgB+I,qBAApB,CAA0C;YAAEb,OAAF;YAAWS,MAAX;YAAmBK,QAAQ9G,GAA3B;YAAgCiG;UAAhC,CAA1C,CAAP;QAAiF;;MAAA,KAG9E9H,oBAH8E;MAG9E,KACAC,oBADA;QACsB;UAEzB,MAAM2H,QAAQ/F,IAAIgG,OAAJ,CAAYD,KAAZ,CACZ,mFADY,CAAd;UAGA,MAAMgB,YAAYhB,QAAQA,MAAM,CAAN,CAAR,GAAmB,GAArC;UACA,MAAME,SAASF,QAAQA,MAAM,CAAN,EAASG,KAAT,CAAe,IAAIc,MAAJ,CAAW,GAAGD,eAAeA,WAA7B,CAAf,CAAR,GAAoE,MAAnF;UAEA,OAAO,IAAIjJ,gBAAgBmJ,yBAApB,CAA8C;YACnDC,SAASC,OAAOtB,OAAP,MAAoBsB,OAAOhJ,oBAAP,CAApB,GAAmD,QAAnD,GAA8D,OADpB;YAEnDiJ,OAAOrB,QAAQA,MAAM,CAAN,CAAR,GAAmB,MAFyB;YAGnDE,MAHmD;YAInDxD,OAAOwD,UAAUA,OAAOhH,MAAjB,IAA2B,KAAK8B,QAAhC,IAA4C,KAAKA,QAAL,CAAckF,OAAO,CAAP,CAAd,CAA5C,IAAwE,MAJ5B;YAKnDoB,OAAOtB,QAAQA,MAAM,CAAN,CAAR,GAAmB,MALyB;YAMnDe,QAAQ9G;UAN2C,CAA9C,CAAP;QAMU;;MAAA;QAKV,OAAO,IAAIlC,gBAAgBwJ,aAApB,CAAkCtH,GAAlC,CAAP;IApDJ;EAoD6C;;EAI/CoE,uBAAuBvD,IAAvB,EAA6B;IAE3BA,OAAOA,KAAKoB,MAAL,CAAY,CAACsF,GAAD,EAAMC,IAAN,KAAe;MAChC,IAAI,EAAEA,KAAKC,QAAL,IAAiBF,GAAnB,CAAJ,EAA6B;QAC3BA,IAAIC,KAAKC,QAAT,IAAqBD,IAArB;QACAA,KAAKvB,MAAL,GAAc,EAAd;MAAc;;MAGhBsB,IAAIC,KAAKC,QAAT,EAAmBxB,MAAnB,CAA0BuB,KAAKE,YAAL,GAAoB,CAA9C,IAAmD;QACjDC,WAAWH,KAAKI,WADiC;QAEjD3I,QAAQuI,KAAKK,QAAL,IAAiB,MAFwB;QAGjDC,OAAON,KAAKO,SAAL,KAAmB,GAAnB,GAAyB,KAAzB,GAAiC;MAHS,CAAnD;MAKA,OAAOP,KAAKQ,WAAZ;MAEA,OAAOT,GAAP;IAAO,CAbF,EAcJ,EAdI,CAAP;IAgBA,OAAOxJ,EAAEuE,GAAF,CAAMzB,IAAN,EAAY2G,SAAS;MAC1BS,SAAST,KAAKC,QAAL,KAAkB,SADD;MAE1BxB,QAAQuB,KAAKvB,MAFa;MAG1B9E,MAAMqG,KAAKC,QAHe;MAI1BS,WAAWV,KAAKW,KAJU;MAK1BC,QAAQZ,KAAKa,UAAL,KAAoB,CALF;MAM1BnF,MAAMsE,KAAKc;IANe,CAAT,CAAZ,CAAP;EAMa;;AAlSiB;;AAuSlCC,OAAOC,OAAP,GAAiBC,KAAjB;AACAF,OAAOC,OAAP,CAAeC,KAAf,GAAuBA,KAAvB;AACAF,OAAOC,OAAP,CAAeE,OAAf,GAAyBD,KAAzB","names":["AbstractQuery","require","sequelizeErrors","_","logger","ER_DUP_ENTRY","ER_DEADLOCK","ER_ROW_IS_REFERENCED","ER_NO_REFERENCED_ROW","debug","debugContext","sql","values","dialect","bindParam","replacementFunc","_match","key","values_","push","formatBindParameters","length","parameters","connection","options","showWarnings","sequelize","complete","_logQuery","results","Promise","resolve","reject","execute","sqlText","binds","err","_stmt","rows","error","transaction","errno","rollback","error_","finished","formatError","warningStatus","logWarnings","formatResults","data","result","instance","isInsertQuery","handleInsertQuery","constructor","name","model","autoIncrementAttribute","primaryKeyAttribute","rawAttributes","startId","getInsertIdField","i","affectedRows","field","isSelectQuery","raw","quoteIdentifiers","sfAttrMap","reduce","m","v","k","toUpperCase","map","data2","prev","value","fieldMap","mapKeys","handleSelectQuery","isShowTablesQuery","handleShowTablesQuery","isDescribeQuery","_result","Field","type","Type","allowNull","Null","defaultValue","Default","primaryKey","Key","autoIncrement","Object","prototype","hasOwnProperty","call","Extra","toLowerCase","comment","Comment","isShowIndexesQuery","handleShowIndexesQuery","isCallQuery","isBulkUpdateQuery","isBulkDeleteQuery","isVersionQuery","version","isForeignKeysQuery","isUpsertQuery","isUpdateQuery","isShowConstraintsQuery","isRawQuery","warningResults","run","warningMessage","uuid","messages","_warningRow","Symbol","iterator","_warningResult","Message","_objectKey","keys","join","log","errCode","code","match","message","fields","split","fieldKey","fieldVal","uniqueKey","uniqueKeys","msg","zipObject","errors","forOwn","ValidationErrorItem","getUniqueConstraintErrorMessage","UniqueConstraintError","parent","quoteChar","RegExp","ForeignKeyConstraintError","reltype","String","table","index","DatabaseError","acc","item","Key_name","Seq_in_index","attribute","Column_name","Sub_part","order","Collation","column_name","primary","tableName","Table","unique","Non_unique","Index_type","module","exports","Query","default"],"sources":["/Users/aurele/node_modules/sequelize/src/dialects/snowflake/query.js"],"sourcesContent":["'use strict';\n\nconst AbstractQuery = require('../abstract/query');\nconst sequelizeErrors = require('../../errors');\nconst _ = require('lodash');\nconst { logger } = require('../../utils/logger');\n\nconst ER_DUP_ENTRY = 1062;\nconst ER_DEADLOCK = 1213;\nconst ER_ROW_IS_REFERENCED = 1451;\nconst ER_NO_REFERENCED_ROW = 1452;\n\nconst debug = logger.debugContext('sql:snowflake');\n\nclass Query extends AbstractQuery {\n  static formatBindParameters(sql, values, dialect) {\n    const bindParam = [];\n    const replacementFunc = (_match, key, values_) => {\n      if (values_[key] !== undefined) {\n        bindParam.push(values_[key]);\n        return '?';\n      }\n      return undefined;\n    };\n    sql = AbstractQuery.formatBindParameters(sql, values, dialect, replacementFunc)[0];\n    return [sql, bindParam.length > 0 ? bindParam : undefined];\n  }\n\n  async run(sql, parameters) {\n    this.sql = sql;\n    const { connection, options } = this;\n\n    const showWarnings = this.sequelize.options.showWarnings || options.showWarnings;\n\n    const complete = this._logQuery(sql, debug, parameters);\n\n    if (parameters) {\n      debug('parameters(%j)', parameters);\n    }\n\n    let results;\n\n    try {\n      results = await new Promise((resolve, reject) => {\n        connection.execute({\n          sqlText: sql,\n          binds: parameters,\n          complete(err, _stmt, rows) {\n            if (err) {\n              reject(err);\n            } else {\n              resolve(rows);\n            }\n          }\n        });\n      });\n    } catch (error) {\n      if (options.transaction && error.errno === ER_DEADLOCK) {\n        try {\n          await options.transaction.rollback();\n        } catch (error_) {\n          // ignore errors\n        }\n\n        options.transaction.finished = 'rollback';\n      }\n\n      error.sql = sql;\n      error.parameters = parameters;\n      throw this.formatError(error);\n    } finally {\n      complete();\n    }\n\n    if (showWarnings && results && results.warningStatus > 0) {\n      await this.logWarnings(results);\n    }\n    return this.formatResults(results);\n  }\n\n  /**\n   * High level function that handles the results of a query execution.\n   *\n   *\n   * Example:\n   *  query.formatResults([\n   *    {\n   *      id: 1,              // this is from the main table\n   *      attr2: 'snafu',     // this is from the main table\n   *      Tasks.id: 1,        // this is from the associated table\n   *      Tasks.title: 'task' // this is from the associated table\n   *    }\n   *  ])\n   *\n   * @param {Array} data - The result of the query execution.\n   * @private\n   */\n  formatResults(data) {\n    let result = this.instance;\n\n    if (this.isInsertQuery(data)) {\n      this.handleInsertQuery(data);\n\n      if (!this.instance) {\n        // handle bulkCreate AI primary key\n        if (\n          data.constructor.name === 'ResultSetHeader'\n          && this.model\n          && this.model.autoIncrementAttribute\n          && this.model.autoIncrementAttribute === this.model.primaryKeyAttribute\n          && this.model.rawAttributes[this.model.primaryKeyAttribute]\n        ) {\n          const startId = data[this.getInsertIdField()];\n          result = [];\n          for (let i = startId; i < startId + data.affectedRows; i++) {\n            result.push({ [this.model.rawAttributes[this.model.primaryKeyAttribute].field]: i });\n          }\n        } else {\n          result = data[this.getInsertIdField()];\n        }\n      }\n    }\n\n    if (this.isSelectQuery()) {\n      // Snowflake will treat tables as case-insensitive, so fix the case\n      // of the returned values to match attributes\n      if (this.options.raw === false && this.sequelize.options.quoteIdentifiers === false) {\n        const sfAttrMap = _.reduce(this.model.rawAttributes, (m, v, k) => {\n          m[k.toUpperCase()] = k;\n          return m;\n        }, {});\n\n        data = data.map(data => _.reduce(data, (prev, value, key) => {\n          if ( value !== undefined && sfAttrMap[key] ) {\n            prev[sfAttrMap[key]] = value;\n            delete prev[key];\n          }\n          return prev;\n        }, data));\n      }\n\n      this.options.fieldMap = _.mapKeys(this.options.fieldMap, (v, k) => { return k.toUpperCase(); });\n\n      return this.handleSelectQuery(data);\n    }\n\n    if (this.isShowTablesQuery()) {\n      return this.handleShowTablesQuery(data);\n    }\n\n    if (this.isDescribeQuery()) {\n      result = {};\n\n      for (const _result of data) {\n        result[_result.Field] = {\n          type: _result.Type.toUpperCase(),\n          allowNull: _result.Null === 'YES',\n          defaultValue: _result.Default,\n          primaryKey: _result.Key === 'PRI',\n          autoIncrement: Object.prototype.hasOwnProperty.call(_result, 'Extra')\n            && _result.Extra.toLowerCase() === 'auto_increment',\n          comment: _result.Comment ? _result.Comment : null\n        };\n      }\n      return result;\n    }\n    if (this.isShowIndexesQuery()) {\n      return this.handleShowIndexesQuery(data);\n    }\n    if (this.isCallQuery()) {\n      return data[0];\n    }\n    if (this.isBulkUpdateQuery() || this.isBulkDeleteQuery()) {\n      return data[0]['number of rows updated'];\n    }\n    if (this.isVersionQuery()) {\n      return data[0].version;\n    }\n    if (this.isForeignKeysQuery()) {\n      return data;\n    }\n    if (this.isUpsertQuery()) {\n      return [result, data.affectedRows === 1];\n    }\n    if (this.isInsertQuery() || this.isUpdateQuery()) {\n      return [result, data.affectedRows];\n    }\n    if (this.isShowConstraintsQuery()) {\n      return data;\n    }\n    if (this.isRawQuery()) {\n      return [data, data];\n    }\n\n    return result;\n  }\n\n  async logWarnings(results) {\n    const warningResults = await this.run('SHOW WARNINGS');\n    const warningMessage = `Snowflake Warnings (${this.connection.uuid || 'default'}): `;\n    const messages = [];\n    for (const _warningRow of warningResults) {\n      if (_warningRow === undefined || typeof _warningRow[Symbol.iterator] !== 'function') {\n        continue;\n      }\n      for (const _warningResult of _warningRow) {\n        if (Object.prototype.hasOwnProperty.call(_warningResult, 'Message')) {\n          messages.push(_warningResult.Message);\n        } else {\n          for (const _objectKey of _warningResult.keys()) {\n            messages.push([_objectKey, _warningResult[_objectKey]].join(': '));\n          }\n        }\n      }\n    }\n\n    this.sequelize.log(warningMessage + messages.join('; '), this.options);\n\n    return results;\n  }\n\n  formatError(err) {\n    const errCode = err.errno || err.code;\n\n    switch (errCode) {\n      case ER_DUP_ENTRY: {\n        const match = err.message.match(/Duplicate entry '([\\s\\S]*)' for key '?((.|\\s)*?)'?$/);\n        let fields = {};\n        let message = 'Validation error';\n        const values = match ? match[1].split('-') : undefined;\n        const fieldKey = match ? match[2] : undefined;\n        const fieldVal = match ? match[1] : undefined;\n        const uniqueKey = this.model && this.model.uniqueKeys[fieldKey];\n\n        if (uniqueKey) {\n          if (uniqueKey.msg) message = uniqueKey.msg;\n          fields = _.zipObject(uniqueKey.fields, values);\n        } else {\n          fields[fieldKey] = fieldVal;\n        }\n\n        const errors = [];\n        _.forOwn(fields, (value, field) => {\n          errors.push(new sequelizeErrors.ValidationErrorItem(\n            this.getUniqueConstraintErrorMessage(field),\n            'unique violation', // sequelizeErrors.ValidationErrorItem.Origins.DB,\n            field,\n            value,\n            this.instance,\n            'not_unique'\n          ));\n        });\n\n        return new sequelizeErrors.UniqueConstraintError({ message, errors, parent: err, fields });\n      }\n\n      case ER_ROW_IS_REFERENCED:\n      case ER_NO_REFERENCED_ROW: {\n        // e.g. CONSTRAINT `example_constraint_name` FOREIGN KEY (`example_id`) REFERENCES `examples` (`id`)\n        const match = err.message.match(\n          /CONSTRAINT ([`\"])(.*)\\1 FOREIGN KEY \\(\\1(.*)\\1\\) REFERENCES \\1(.*)\\1 \\(\\1(.*)\\1\\)/\n        );\n        const quoteChar = match ? match[1] : '`';\n        const fields = match ? match[3].split(new RegExp(`${quoteChar}, *${quoteChar}`)) : undefined;\n\n        return new sequelizeErrors.ForeignKeyConstraintError({\n          reltype: String(errCode) === String(ER_ROW_IS_REFERENCED) ? 'parent' : 'child',\n          table: match ? match[4] : undefined,\n          fields,\n          value: fields && fields.length && this.instance && this.instance[fields[0]] || undefined,\n          index: match ? match[2] : undefined,\n          parent: err\n        });\n      }\n\n      default:\n        return new sequelizeErrors.DatabaseError(err);\n    }\n  }\n\n  handleShowIndexesQuery(data) {\n    // Group by index name, and collect all fields\n    data = data.reduce((acc, item) => {\n      if (!(item.Key_name in acc)) {\n        acc[item.Key_name] = item;\n        item.fields = [];\n      }\n\n      acc[item.Key_name].fields[item.Seq_in_index - 1] = {\n        attribute: item.Column_name,\n        length: item.Sub_part || undefined,\n        order: item.Collation === 'A' ? 'ASC' : undefined\n      };\n      delete item.column_name;\n\n      return acc;\n    }, {});\n\n    return _.map(data, item => ({\n      primary: item.Key_name === 'PRIMARY',\n      fields: item.fields,\n      name: item.Key_name,\n      tableName: item.Table,\n      unique: item.Non_unique !== 1,\n      type: item.Index_type\n    }));\n  }\n}\n\nmodule.exports = Query;\nmodule.exports.Query = Query;\nmodule.exports.default = Query;\n"]},"metadata":{},"sourceType":"script"}