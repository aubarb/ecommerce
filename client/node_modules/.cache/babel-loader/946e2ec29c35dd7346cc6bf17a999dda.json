{"ast":null,"code":"\"use strict\";\n\nconst AbstractQuery = require(\"../abstract/query\");\n\nconst sequelizeErrors = require(\"../../errors\");\n\nconst parserStore = require(\"../parserStore\")(\"mssql\");\n\nconst _ = require(\"lodash\");\n\nconst {\n  logger\n} = require(\"../../utils/logger\");\n\nconst debug = logger.debugContext(\"sql:mssql\");\nconst minSafeIntegerAsBigInt = BigInt(Number.MIN_SAFE_INTEGER);\nconst maxSafeIntegerAsBigInt = BigInt(Number.MAX_SAFE_INTEGER);\n\nfunction getScale(aNum) {\n  if (!Number.isFinite(aNum)) return 0;\n  let e = 1;\n\n  while (Math.round(aNum * e) / e !== aNum) e *= 10;\n\n  return Math.log10(e);\n}\n\nclass Query extends AbstractQuery {\n  getInsertIdField() {\n    return \"id\";\n  }\n\n  getSQLTypeFromJsType(value, TYPES) {\n    const paramType = {\n      type: TYPES.NVarChar,\n      typeOptions: {},\n      value\n    };\n\n    if (typeof value === \"number\") {\n      if (Number.isInteger(value)) {\n        if (value >= -2147483648 && value <= 2147483647) {\n          paramType.type = TYPES.Int;\n        } else {\n          paramType.type = TYPES.BigInt;\n        }\n      } else {\n        paramType.type = TYPES.Numeric;\n        paramType.typeOptions = {\n          precision: 30,\n          scale: getScale(value)\n        };\n      }\n    } else if (typeof value === \"bigint\") {\n      if (value < minSafeIntegerAsBigInt || value > maxSafeIntegerAsBigInt) {\n        paramType.type = TYPES.VarChar;\n        paramType.value = value.toString();\n      } else {\n        return this.getSQLTypeFromJsType(Number(value), TYPES);\n      }\n    } else if (typeof value === \"boolean\") {\n      paramType.type = TYPES.Bit;\n    }\n\n    if (Buffer.isBuffer(value)) {\n      paramType.type = TYPES.VarBinary;\n    }\n\n    return paramType;\n  }\n\n  async _run(connection, sql, parameters, errStack) {\n    this.sql = sql;\n    const {\n      options\n    } = this;\n\n    const complete = this._logQuery(sql, debug, parameters);\n\n    const query = new Promise((resolve, reject) => {\n      if (sql.startsWith(\"BEGIN TRANSACTION\")) {\n        return connection.beginTransaction(error => error ? reject(error) : resolve([]), options.transaction.name, connection.lib.ISOLATION_LEVEL[options.isolationLevel]);\n      }\n\n      if (sql.startsWith(\"COMMIT TRANSACTION\")) {\n        return connection.commitTransaction(error => error ? reject(error) : resolve([]));\n      }\n\n      if (sql.startsWith(\"ROLLBACK TRANSACTION\")) {\n        return connection.rollbackTransaction(error => error ? reject(error) : resolve([]), options.transaction.name);\n      }\n\n      if (sql.startsWith(\"SAVE TRANSACTION\")) {\n        return connection.saveTransaction(error => error ? reject(error) : resolve([]), options.transaction.name);\n      }\n\n      const rows2 = [];\n      const request = new connection.lib.Request(sql, (err, rowCount2) => err ? reject(err) : resolve([rows2, rowCount2]));\n\n      if (parameters) {\n        _.forOwn(parameters, (value, key) => {\n          const paramType = this.getSQLTypeFromJsType(value, connection.lib.TYPES);\n          request.addParameter(key, paramType.type, value, paramType.typeOptions);\n        });\n      }\n\n      request.on(\"row\", columns => {\n        rows2.push(columns);\n      });\n      connection.execSql(request);\n    });\n    let rows, rowCount;\n\n    try {\n      [rows, rowCount] = await query;\n    } catch (err) {\n      err.sql = sql;\n      err.parameters = parameters;\n      throw this.formatError(err, errStack);\n    }\n\n    complete();\n\n    if (Array.isArray(rows)) {\n      rows = rows.map(columns => {\n        const row = {};\n\n        for (const column of columns) {\n          const typeid = column.metadata.type.id;\n          const parse = parserStore.get(typeid);\n          let value = column.value;\n\n          if (value !== null & !!parse) {\n            value = parse(value);\n          }\n\n          row[column.metadata.colName] = value;\n        }\n\n        return row;\n      });\n    }\n\n    return this.formatResults(rows, rowCount);\n  }\n\n  run(sql, parameters) {\n    const errForStack = new Error();\n    return this.connection.queue.enqueue(() => this._run(this.connection, sql, parameters, errForStack.stack));\n  }\n\n  static formatBindParameters(sql, values, dialect) {\n    const bindParam = {};\n\n    const replacementFunc = (match, key, values2) => {\n      if (values2[key] !== void 0) {\n        bindParam[key] = values2[key];\n        return `@${key}`;\n      }\n\n      return void 0;\n    };\n\n    sql = AbstractQuery.formatBindParameters(sql, values, dialect, replacementFunc)[0];\n    return [sql, bindParam];\n  }\n\n  formatResults(data, rowCount) {\n    if (this.isInsertQuery(data)) {\n      this.handleInsertQuery(data);\n      return [this.instance || data, rowCount];\n    }\n\n    if (this.isShowTablesQuery()) {\n      return this.handleShowTablesQuery(data);\n    }\n\n    if (this.isDescribeQuery()) {\n      const result = {};\n\n      for (const _result of data) {\n        if (_result.Default) {\n          _result.Default = _result.Default.replace(\"('\", \"\").replace(\"')\", \"\").replace(/'/g, \"\");\n        }\n\n        result[_result.Name] = {\n          type: _result.Type.toUpperCase(),\n          allowNull: _result.IsNull === \"YES\" ? true : false,\n          defaultValue: _result.Default,\n          primaryKey: _result.Constraint === \"PRIMARY KEY\",\n          autoIncrement: _result.IsIdentity === 1,\n          comment: _result.Comment\n        };\n\n        if (result[_result.Name].type.includes(\"CHAR\") && _result.Length) {\n          if (_result.Length === -1) {\n            result[_result.Name].type += \"(MAX)\";\n          } else {\n            result[_result.Name].type += `(${_result.Length})`;\n          }\n        }\n      }\n\n      return result;\n    }\n\n    if (this.isSelectQuery()) {\n      return this.handleSelectQuery(data);\n    }\n\n    if (this.isShowIndexesQuery()) {\n      return this.handleShowIndexesQuery(data);\n    }\n\n    if (this.isCallQuery()) {\n      return data[0];\n    }\n\n    if (this.isBulkUpdateQuery()) {\n      if (this.options.returning) {\n        return this.handleSelectQuery(data);\n      }\n\n      return rowCount;\n    }\n\n    if (this.isBulkDeleteQuery()) {\n      return data[0] ? data[0].AFFECTEDROWS : 0;\n    }\n\n    if (this.isVersionQuery()) {\n      return data[0].version;\n    }\n\n    if (this.isForeignKeysQuery()) {\n      return data;\n    }\n\n    if (this.isUpsertQuery()) {\n      if (data && data.length === 0) {\n        return [this.instance || data, false];\n      }\n\n      this.handleInsertQuery(data);\n      return [this.instance || data, data[0].$action === \"INSERT\"];\n    }\n\n    if (this.isUpdateQuery()) {\n      return [this.instance || data, rowCount];\n    }\n\n    if (this.isShowConstraintsQuery()) {\n      return this.handleShowConstraintsQuery(data);\n    }\n\n    if (this.isRawQuery()) {\n      return [data, rowCount];\n    }\n\n    return data;\n  }\n\n  handleShowTablesQuery(results) {\n    return results.map(resultSet => {\n      return {\n        tableName: resultSet.TABLE_NAME,\n        schema: resultSet.TABLE_SCHEMA\n      };\n    });\n  }\n\n  handleShowConstraintsQuery(data) {\n    return data.slice(1).map(result => {\n      const constraint = {};\n\n      for (const key in result) {\n        constraint[_.camelCase(key)] = result[key];\n      }\n\n      return constraint;\n    });\n  }\n\n  formatError(err, errStack) {\n    let match;\n    match = err.message.match(/Violation of (?:UNIQUE|PRIMARY) KEY constraint '([^']*)'. Cannot insert duplicate key in object '.*'.(:? The duplicate key value is \\((.*)\\).)?/);\n    match = match || err.message.match(/Cannot insert duplicate key row in object .* with unique index '(.*)'/);\n\n    if (match && match.length > 1) {\n      let fields = {};\n      const uniqueKey = this.model && this.model.uniqueKeys[match[1]];\n      let message = \"Validation error\";\n\n      if (uniqueKey && !!uniqueKey.msg) {\n        message = uniqueKey.msg;\n      }\n\n      if (match[3]) {\n        const values = match[3].split(\",\").map(part => part.trim());\n\n        if (uniqueKey) {\n          fields = _.zipObject(uniqueKey.fields, values);\n        } else {\n          fields[match[1]] = match[3];\n        }\n      }\n\n      const errors = [];\n\n      _.forOwn(fields, (value, field) => {\n        errors.push(new sequelizeErrors.ValidationErrorItem(this.getUniqueConstraintErrorMessage(field), \"unique violation\", field, value, this.instance, \"not_unique\"));\n      });\n\n      return new sequelizeErrors.UniqueConstraintError({\n        message,\n        errors,\n        parent: err,\n        fields,\n        stack: errStack\n      });\n    }\n\n    match = err.message.match(/Failed on step '(.*)'.Could not create constraint. See previous errors./) || err.message.match(/The DELETE statement conflicted with the REFERENCE constraint \"(.*)\". The conflict occurred in database \"(.*)\", table \"(.*)\", column '(.*)'./) || err.message.match(/The (?:INSERT|MERGE|UPDATE) statement conflicted with the FOREIGN KEY constraint \"(.*)\". The conflict occurred in database \"(.*)\", table \"(.*)\", column '(.*)'./);\n\n    if (match && match.length > 0) {\n      return new sequelizeErrors.ForeignKeyConstraintError({\n        fields: null,\n        index: match[1],\n        parent: err,\n        stack: errStack\n      });\n    }\n\n    match = err.message.match(/Could not drop constraint. See previous errors./);\n\n    if (match && match.length > 0) {\n      let constraint = err.sql.match(/(?:constraint|index) \\[(.+?)\\]/i);\n      constraint = constraint ? constraint[1] : void 0;\n      let table = err.sql.match(/table \\[(.+?)\\]/i);\n      table = table ? table[1] : void 0;\n      return new sequelizeErrors.UnknownConstraintError({\n        message: match[1],\n        constraint,\n        table,\n        parent: err,\n        stack: errStack\n      });\n    }\n\n    return new sequelizeErrors.DatabaseError(err, {\n      stack: errStack\n    });\n  }\n\n  isShowOrDescribeQuery() {\n    let result = false;\n    result = result || this.sql.toLowerCase().startsWith(\"select c.column_name as 'name', c.data_type as 'type', c.is_nullable as 'isnull'\");\n    result = result || this.sql.toLowerCase().startsWith(\"select tablename = t.name, name = ind.name,\");\n    result = result || this.sql.toLowerCase().startsWith(\"exec sys.sp_helpindex @objname\");\n    return result;\n  }\n\n  isShowIndexesQuery() {\n    return this.sql.toLowerCase().startsWith(\"exec sys.sp_helpindex @objname\");\n  }\n\n  handleShowIndexesQuery(data) {\n    data = data.reduce((acc, item) => {\n      if (!(item.index_name in acc)) {\n        acc[item.index_name] = item;\n        item.fields = [];\n      }\n\n      item.index_keys.split(\",\").forEach(column => {\n        let columnName = column.trim();\n\n        if (columnName.includes(\"(-)\")) {\n          columnName = columnName.replace(\"(-)\", \"\");\n        }\n\n        acc[item.index_name].fields.push({\n          attribute: columnName,\n          length: void 0,\n          order: column.includes(\"(-)\") ? \"DESC\" : \"ASC\",\n          collate: void 0\n        });\n      });\n      delete item.index_keys;\n      return acc;\n    }, {});\n    return _.map(data, item => ({\n      primary: item.index_name.toLowerCase().startsWith(\"pk\"),\n      fields: item.fields,\n      name: item.index_name,\n      tableName: void 0,\n      unique: item.index_description.toLowerCase().includes(\"unique\"),\n      type: void 0\n    }));\n  }\n\n  handleInsertQuery(results, metaData) {\n    if (this.instance) {\n      const autoIncrementAttribute = this.model.autoIncrementAttribute;\n      let id = null;\n      let autoIncrementAttributeAlias = null;\n      if (Object.prototype.hasOwnProperty.call(this.model.rawAttributes, autoIncrementAttribute) && this.model.rawAttributes[autoIncrementAttribute].field !== void 0) autoIncrementAttributeAlias = this.model.rawAttributes[autoIncrementAttribute].field;\n      id = id || results && results[0][this.getInsertIdField()];\n      id = id || metaData && metaData[this.getInsertIdField()];\n      id = id || results && results[0][autoIncrementAttribute];\n      id = id || autoIncrementAttributeAlias && results && results[0][autoIncrementAttributeAlias];\n      this.instance[autoIncrementAttribute] = id;\n\n      if (this.instance.dataValues) {\n        for (const key in results[0]) {\n          if (Object.prototype.hasOwnProperty.call(results[0], key)) {\n            const record = results[0][key];\n\n            const attr = _.find(this.model.rawAttributes, attribute => attribute.fieldName === key || attribute.field === key);\n\n            this.instance.dataValues[attr && attr.fieldName || key] = record;\n          }\n        }\n      }\n    }\n  }\n\n}\n\nmodule.exports = Query;\nmodule.exports.Query = Query;\nmodule.exports.default = Query;","map":{"version":3,"mappings":"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","names":["AbstractQuery","require","sequelizeErrors","parserStore","_","logger","debug","debugContext","minSafeIntegerAsBigInt","BigInt","Number","MIN_SAFE_INTEGER","maxSafeIntegerAsBigInt","MAX_SAFE_INTEGER","aNum","isFinite","e","Math","round","log10","getInsertIdField","getSQLTypeFromJsType","value","TYPES","paramType","type","NVarChar","typeOptions","isInteger","Int","Numeric","precision","scale","getScale","VarChar","toString","Bit","Buffer","isBuffer","VarBinary","connection","sql","parameters","errStack","options","complete","_logQuery","query","Promise","resolve","reject","startsWith","beginTransaction","error","transaction","name","lib","ISOLATION_LEVEL","isolationLevel","commitTransaction","rollbackTransaction","saveTransaction","rows2","request","Request","err","rowCount2","forOwn","key","addParameter","on","columns","push","execSql","rows","rowCount","formatError","Array","isArray","map","row","column","typeid","metadata","id","parse","get","colName","formatResults","run","errForStack","Error","queue","enqueue","_run","stack","values","dialect","bindParam","replacementFunc","match","values2","formatBindParameters","data","isInsertQuery","handleInsertQuery","instance","isShowTablesQuery","handleShowTablesQuery","isDescribeQuery","result","_result","Default","replace","Name","Type","toUpperCase","allowNull","IsNull","defaultValue","primaryKey","Constraint","autoIncrement","IsIdentity","comment","Comment","includes","Length","isSelectQuery","handleSelectQuery","isShowIndexesQuery","handleShowIndexesQuery","isCallQuery","isBulkUpdateQuery","returning","isBulkDeleteQuery","AFFECTEDROWS","isVersionQuery","version","isForeignKeysQuery","isUpsertQuery","length","$action","isUpdateQuery","isShowConstraintsQuery","handleShowConstraintsQuery","isRawQuery","results","resultSet","tableName","TABLE_NAME","schema","TABLE_SCHEMA","slice","constraint","camelCase","message","fields","uniqueKey","model","uniqueKeys","msg","split","part","trim","zipObject","errors","field","ValidationErrorItem","getUniqueConstraintErrorMessage","UniqueConstraintError","parent","ForeignKeyConstraintError","index","table","UnknownConstraintError","DatabaseError","isShowOrDescribeQuery","toLowerCase","reduce","acc","item","index_name","index_keys","forEach","columnName","attribute","order","collate","primary","unique","index_description","metaData","autoIncrementAttribute","autoIncrementAttributeAlias","Object","prototype","hasOwnProperty","call","rawAttributes","dataValues","record","attr","find","fieldName","module","exports","Query","default"],"sources":["/Users/aurele/node_modules/sequelize/src/dialects/mssql/query.js"],"sourcesContent":["'use strict';\n\nconst AbstractQuery = require('../abstract/query');\nconst sequelizeErrors = require('../../errors');\nconst parserStore = require('../parserStore')('mssql');\nconst _ = require('lodash');\nconst { logger } = require('../../utils/logger');\n\nconst debug = logger.debugContext('sql:mssql');\n\nconst minSafeIntegerAsBigInt = BigInt(Number.MIN_SAFE_INTEGER);\nconst maxSafeIntegerAsBigInt = BigInt(Number.MAX_SAFE_INTEGER);\n\nfunction getScale(aNum) {\n  if (!Number.isFinite(aNum)) return 0;\n  let e = 1;\n  while (Math.round(aNum * e) / e !== aNum) e *= 10;\n  return Math.log10(e);\n}\n\nclass Query extends AbstractQuery {\n  getInsertIdField() {\n    return 'id';\n  }\n\n  getSQLTypeFromJsType(value, TYPES) {\n    const paramType = { type: TYPES.NVarChar, typeOptions: {}, value };\n    if (typeof value === 'number') {\n      if (Number.isInteger(value)) {\n        if (value >= -2147483648 && value <= 2147483647) {\n          paramType.type = TYPES.Int;\n        } else {\n          paramType.type = TYPES.BigInt;\n        }\n      } else {\n        paramType.type = TYPES.Numeric;\n        //Default to a reasonable numeric precision/scale pending more sophisticated logic\n        paramType.typeOptions = { precision: 30, scale: getScale(value) };\n      }\n    } else if (typeof value === 'bigint') {\n      if (value < minSafeIntegerAsBigInt || value > maxSafeIntegerAsBigInt) {\n        paramType.type = TYPES.VarChar;\n        paramType.value = value.toString();\n      } else {\n        return this.getSQLTypeFromJsType(Number(value), TYPES);\n      }\n    } else if (typeof value === 'boolean') {\n      paramType.type = TYPES.Bit;\n    }\n    if (Buffer.isBuffer(value)) {\n      paramType.type = TYPES.VarBinary;\n    }\n    return paramType;\n  }\n\n  async _run(connection, sql, parameters, errStack) {\n    this.sql = sql;\n    const { options } = this;\n\n    const complete = this._logQuery(sql, debug, parameters);\n\n    const query = new Promise((resolve, reject) => {\n      // TRANSACTION SUPPORT\n      if (sql.startsWith('BEGIN TRANSACTION')) {\n        return connection.beginTransaction(error => error ? reject(error) : resolve([]), options.transaction.name, connection.lib.ISOLATION_LEVEL[options.isolationLevel]);\n      }\n      if (sql.startsWith('COMMIT TRANSACTION')) {\n        return connection.commitTransaction(error => error ? reject(error) : resolve([]));\n      }\n      if (sql.startsWith('ROLLBACK TRANSACTION')) {\n        return connection.rollbackTransaction(error => error ? reject(error) : resolve([]), options.transaction.name);\n      }\n      if (sql.startsWith('SAVE TRANSACTION')) {\n        return connection.saveTransaction(error => error ? reject(error) : resolve([]), options.transaction.name);\n      }\n\n      const rows = [];\n      const request = new connection.lib.Request(sql, (err, rowCount) => err ? reject(err) : resolve([rows, rowCount]));\n\n      if (parameters) {\n        _.forOwn(parameters, (value, key) => {\n          const paramType = this.getSQLTypeFromJsType(value, connection.lib.TYPES);\n          request.addParameter(key, paramType.type, value, paramType.typeOptions);\n        });\n      }\n\n      request.on('row', columns => {\n        rows.push(columns);\n      });\n\n      connection.execSql(request);\n    });\n\n    let rows, rowCount;\n\n    try {\n      [rows, rowCount] = await query;\n    } catch (err) {\n      err.sql = sql;\n      err.parameters = parameters;\n\n      throw this.formatError(err, errStack);\n    }\n\n    complete();\n\n    if (Array.isArray(rows)) {\n      rows = rows.map(columns => {\n        const row = {};\n        for (const column of columns) {\n          const typeid = column.metadata.type.id;\n          const parse = parserStore.get(typeid);\n          let value = column.value;\n\n          if (value !== null & !!parse) {\n            value = parse(value);\n          }\n          row[column.metadata.colName] = value;\n        }\n        return row;\n      });\n    }\n\n    return this.formatResults(rows, rowCount);\n  }\n\n  run(sql, parameters) {\n    const errForStack = new Error();\n    return this.connection.queue.enqueue(() =>\n      this._run(this.connection, sql, parameters, errForStack.stack)\n    );\n  }\n\n  static formatBindParameters(sql, values, dialect) {\n    const bindParam = {};\n    const replacementFunc = (match, key, values) => {\n      if (values[key] !== undefined) {\n        bindParam[key] = values[key];\n        return `@${key}`;\n      }\n      return undefined;\n    };\n    sql = AbstractQuery.formatBindParameters(sql, values, dialect, replacementFunc)[0];\n\n    return [sql, bindParam];\n  }\n\n  /**\n   * High level function that handles the results of a query execution.\n   *\n   * @param {Array} data - The result of the query execution.\n   * @param {number} rowCount\n   * @private\n   * @example\n   * Example:\n   *  query.formatResults([\n   *    {\n   *      id: 1,              // this is from the main table\n   *      attr2: 'snafu',     // this is from the main table\n   *      Tasks.id: 1,        // this is from the associated table\n   *      Tasks.title: 'task' // this is from the associated table\n   *    }\n   *  ])\n   */\n  formatResults(data, rowCount) {\n    if (this.isInsertQuery(data)) {\n      this.handleInsertQuery(data);\n      return [this.instance || data, rowCount];\n    }\n    if (this.isShowTablesQuery()) {\n      return this.handleShowTablesQuery(data);\n    }\n    if (this.isDescribeQuery()) {\n      const result = {};\n      for (const _result of data) {\n        if (_result.Default) {\n          _result.Default = _result.Default.replace(\"('\", '').replace(\"')\", '').replace(/'/g, '');\n        }\n\n        result[_result.Name] = {\n          type: _result.Type.toUpperCase(),\n          allowNull: _result.IsNull === 'YES' ? true : false,\n          defaultValue: _result.Default,\n          primaryKey: _result.Constraint === 'PRIMARY KEY',\n          autoIncrement: _result.IsIdentity === 1,\n          comment: _result.Comment\n        };\n\n        if (\n          result[_result.Name].type.includes('CHAR')\n          && _result.Length\n        ) {\n          if (_result.Length === -1) {\n            result[_result.Name].type += '(MAX)';\n          } else {\n            result[_result.Name].type += `(${_result.Length})`;\n          }\n        }\n      }\n      return result;\n    }\n    if (this.isSelectQuery()) {\n      return this.handleSelectQuery(data);\n    }\n    if (this.isShowIndexesQuery()) {\n      return this.handleShowIndexesQuery(data);\n    }\n    if (this.isCallQuery()) {\n      return data[0];\n    }\n    if (this.isBulkUpdateQuery()) {\n      if (this.options.returning) {\n        return this.handleSelectQuery(data);\n      }\n\n      return rowCount;\n    }\n    if (this.isBulkDeleteQuery()) {\n      return data[0] ? data[0].AFFECTEDROWS : 0;\n    }\n    if (this.isVersionQuery()) {\n      return data[0].version;\n    }\n    if (this.isForeignKeysQuery()) {\n      return data;\n    }\n    if (this.isUpsertQuery()) {\n      // if this was an upsert and no data came back, that means the record exists, but the update was a noop.\n      // return the current instance and mark it as an \"not an insert\".\n      if (data && data.length === 0) {\n        return [this.instance || data, false];\n      }\n      this.handleInsertQuery(data);\n      return [this.instance || data, data[0].$action === 'INSERT'];\n    }\n    if (this.isUpdateQuery()) {\n      return [this.instance || data, rowCount];\n    }\n    if (this.isShowConstraintsQuery()) {\n      return this.handleShowConstraintsQuery(data);\n    }\n    if (this.isRawQuery()) {\n      return [data, rowCount];\n    }\n    return data;\n  }\n\n  handleShowTablesQuery(results) {\n    return results.map(resultSet => {\n      return {\n        tableName: resultSet.TABLE_NAME,\n        schema: resultSet.TABLE_SCHEMA\n      };\n    });\n  }\n\n  handleShowConstraintsQuery(data) {\n    //Convert snake_case keys to camelCase as it's generated by stored procedure\n    return data.slice(1).map(result => {\n      const constraint = {};\n      for (const key in result) {\n        constraint[_.camelCase(key)] = result[key];\n      }\n      return constraint;\n    });\n  }\n\n  formatError(err, errStack) {\n    let match;\n\n    match = err.message.match(/Violation of (?:UNIQUE|PRIMARY) KEY constraint '([^']*)'. Cannot insert duplicate key in object '.*'.(:? The duplicate key value is \\((.*)\\).)?/);\n    match = match || err.message.match(/Cannot insert duplicate key row in object .* with unique index '(.*)'/);\n    if (match && match.length > 1) {\n      let fields = {};\n      const uniqueKey = this.model && this.model.uniqueKeys[match[1]];\n      let message = 'Validation error';\n\n      if (uniqueKey && !!uniqueKey.msg) {\n        message = uniqueKey.msg;\n      }\n      if (match[3]) {\n        const values = match[3].split(',').map(part => part.trim());\n        if (uniqueKey) {\n          fields = _.zipObject(uniqueKey.fields, values);\n        } else {\n          fields[match[1]] = match[3];\n        }\n      }\n\n      const errors = [];\n      _.forOwn(fields, (value, field) => {\n        errors.push(new sequelizeErrors.ValidationErrorItem(\n          this.getUniqueConstraintErrorMessage(field),\n          'unique violation', // sequelizeErrors.ValidationErrorItem.Origins.DB,\n          field,\n          value,\n          this.instance,\n          'not_unique'\n        ));\n      });\n\n      return new sequelizeErrors.UniqueConstraintError({ message, errors, parent: err, fields, stack: errStack });\n    }\n\n    match = err.message.match(/Failed on step '(.*)'.Could not create constraint. See previous errors./) ||\n      err.message.match(/The DELETE statement conflicted with the REFERENCE constraint \"(.*)\". The conflict occurred in database \"(.*)\", table \"(.*)\", column '(.*)'./) ||\n      err.message.match(/The (?:INSERT|MERGE|UPDATE) statement conflicted with the FOREIGN KEY constraint \"(.*)\". The conflict occurred in database \"(.*)\", table \"(.*)\", column '(.*)'./);\n    if (match && match.length > 0) {\n      return new sequelizeErrors.ForeignKeyConstraintError({\n        fields: null,\n        index: match[1],\n        parent: err,\n        stack: errStack\n      });\n    }\n\n    match = err.message.match(/Could not drop constraint. See previous errors./);\n    if (match && match.length > 0) {\n      let constraint = err.sql.match(/(?:constraint|index) \\[(.+?)\\]/i);\n      constraint = constraint ? constraint[1] : undefined;\n      let table = err.sql.match(/table \\[(.+?)\\]/i);\n      table = table ? table[1] : undefined;\n\n      return new sequelizeErrors.UnknownConstraintError({\n        message: match[1],\n        constraint,\n        table,\n        parent: err,\n        stack: errStack\n      });\n    }\n\n    return new sequelizeErrors.DatabaseError(err, { stack: errStack });\n  }\n\n  isShowOrDescribeQuery() {\n    let result = false;\n\n    result = result || this.sql.toLowerCase().startsWith(\"select c.column_name as 'name', c.data_type as 'type', c.is_nullable as 'isnull'\");\n    result = result || this.sql.toLowerCase().startsWith('select tablename = t.name, name = ind.name,');\n    result = result || this.sql.toLowerCase().startsWith('exec sys.sp_helpindex @objname');\n\n    return result;\n  }\n\n  isShowIndexesQuery() {\n    return this.sql.toLowerCase().startsWith('exec sys.sp_helpindex @objname');\n  }\n\n  handleShowIndexesQuery(data) {\n    // Group by index name, and collect all fields\n    data = data.reduce((acc, item) => {\n      if (!(item.index_name in acc)) {\n        acc[item.index_name] = item;\n        item.fields = [];\n      }\n\n      item.index_keys.split(',').forEach(column => {\n        let columnName = column.trim();\n        if (columnName.includes('(-)')) {\n          columnName = columnName.replace('(-)', '');\n        }\n\n        acc[item.index_name].fields.push({\n          attribute: columnName,\n          length: undefined,\n          order: column.includes('(-)') ? 'DESC' : 'ASC',\n          collate: undefined\n        });\n      });\n      delete item.index_keys;\n      return acc;\n    }, {});\n\n    return _.map(data, item => ({\n      primary: item.index_name.toLowerCase().startsWith('pk'),\n      fields: item.fields,\n      name: item.index_name,\n      tableName: undefined,\n      unique: item.index_description.toLowerCase().includes('unique'),\n      type: undefined\n    }));\n  }\n\n  handleInsertQuery(results, metaData) {\n    if (this.instance) {\n      // add the inserted row id to the instance\n      const autoIncrementAttribute = this.model.autoIncrementAttribute;\n      let id = null;\n      let autoIncrementAttributeAlias = null;\n\n      if (Object.prototype.hasOwnProperty.call(this.model.rawAttributes, autoIncrementAttribute) &&\n        this.model.rawAttributes[autoIncrementAttribute].field !== undefined)\n        autoIncrementAttributeAlias = this.model.rawAttributes[autoIncrementAttribute].field;\n\n      id = id || results && results[0][this.getInsertIdField()];\n      id = id || metaData && metaData[this.getInsertIdField()];\n      id = id || results && results[0][autoIncrementAttribute];\n      id = id || autoIncrementAttributeAlias && results && results[0][autoIncrementAttributeAlias];\n\n      this.instance[autoIncrementAttribute] = id;\n\n      if (this.instance.dataValues) {\n        for (const key in results[0]) {\n          if (Object.prototype.hasOwnProperty.call(results[0], key)) {\n            const record = results[0][key];\n\n            const attr = _.find(this.model.rawAttributes, attribute => attribute.fieldName === key || attribute.field === key);\n\n            this.instance.dataValues[attr && attr.fieldName || key] = record;\n          }\n        }\n      }\n\n    }\n  }\n}\n\nmodule.exports = Query;\nmodule.exports.Query = Query;\nmodule.exports.default = Query;\n"]},"metadata":{},"sourceType":"script"}